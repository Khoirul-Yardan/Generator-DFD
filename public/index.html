<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DFD Automation - SQL to Diagram Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9ff;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-area.dragover {
      border-color: #764ba2;
      background: #e8ebff;
    }

    .upload-area svg {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
      color: #667eea;
    }

    .upload-area p {
      color: #666;
      margin: 10px 0;
      font-size: 0.95em;
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      margin-top: 15px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .file-info {
      margin-top: 15px;
      padding: 10px;
      background: #f0f2ff;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      display: none;
    }

    .file-info.active {
      display: block;
    }

    .file-info strong {
      color: #667eea;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results {
      display: none;
      margin-top: 30px;
    }

    .results.active {
      display: block;
    }

    .result-item {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .result-item h3 {
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      background: #667eea;
      color: white;
      border-radius: 20px;
      font-size: 0.8em;
      margin-left: 10px;
    }

    .diagram-preview {
      margin: 15px 0;
      text-align: center;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 6px;
      overflow-x: auto;
    }

    .diagram-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .mermaid {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .mermaid svg {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9em;
      flex: 1;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      display: none;
      border-left: 4px solid #c33;
    }

    .error-message.active {
      display: block;
    }

    .success-message {
      background: #efe;
      color: #3c3;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      display: none;
      border-left: 4px solid #3c3;
    }

    .success-message.active {
      display: block;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 15px 0;
    }

    .stat-box {
      background: #f8f9ff;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #e0e4ff;
    }

    .stat-box .number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-box .label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .mermaid-code {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin: 10px 0;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üéØ DFD Automation</h1>
      <p>Automatic Data Flow Diagram Generator from SQL Database</p>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Upload Section -->
      <div class="card">
        <h2>üì§ Upload SQL Database</h2>
        
        <div class="upload-area" id="uploadArea">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
          </svg>
          <p><strong>Click to upload</strong> or drag and drop</p>
          <p style="font-size: 0.85em;">SQL files only (max 10MB)</p>
        </div>

        <input type="file" id="fileInput" accept=".sql" />

        <div class="file-info" id="fileInfo">
          <strong>Selected:</strong> <span id="fileName"></span>
          <br>
          <strong>Size:</strong> <span id="fileSize"></span>
        </div>

        <button class="btn btn-primary" id="uploadBtn" disabled>
          üöÄ Generate DFD
        </button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Processing your SQL file...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
      </div>

      <!-- Info Section -->
      <div class="card">
        <h2>‚ÑπÔ∏è How it Works</h2>
        <div style="line-height: 1.8; color: #666;">
          <p><strong>Step 1:</strong> Upload your SQL database file</p>
          <p><strong>Step 2:</strong> System analyzes tables, columns & relationships</p>
          <p><strong>Step 3:</strong> Generates DFD automatically from Level 0-2</p>
          <p><strong>Step 4:</strong> Download diagrams as PNG or JSON</p>
          
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
          
          <p style="margin-top: 20px;"><strong>üìã DFD Levels Generated:</strong></p>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li><strong>Level 0:</strong> Context Diagram (System Overview)</li>
            <li><strong>Level 1:</strong> Process Decomposition</li>
            <li><strong>Level 2:</strong> Detailed CRUD Operations</li>
          </ul>

          <p style="margin-top: 20px; font-size: 0.9em; color: #999;">
            All diagrams follow standard DFD notation using Mermaid.js
          </p>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results" id="results">
      <div class="card">
        <h2>‚úÖ DFD Generated Successfully!</h2>

        <div class="success-message active">
          Your Data Flow Diagrams have been generated!
        </div>

        <!-- Statistics -->
        <div class="stats" id="stats"></div>

        <!-- Level 0 Results -->
        <div class="result-item">
          <h3>
            üìä Level 0: Context Diagram
            <span class="badge">System Overview</span>
          </h3>
          <p>Shows the entire system as a single process with external entities and data stores</p>
          
          <div class="action-buttons">
            <a class="btn btn-primary" id="level0Live" target="_blank" style="text-decoration: none;">
              üîó View on Mermaid Live
            </a>
            <button class="btn btn-secondary" onclick="copyToClipboard('level0Code')">
              üìã Copy Code
            </button>
            <button class="btn btn-secondary" onclick="toggleCode('level0Code')">
              üëÅÔ∏è View Code
            </button>
          </div>

          <div class="mermaid-code" id="level0Code" style="display: none;">
            <pre id="level0CodeContent" style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto; margin: 10px 0;"></pre>
          </div>
        </div>

        <!-- Level 1 Results -->
        <div class="result-item">
          <h3>
            üîÄ Level 1: Process Decomposition
            <span class="badge">Processes</span>
          </h3>
          <p>Decomposes context diagram into main processes</p>
          
          <div class="action-buttons">
            <a class="btn btn-primary" id="level1Live" target="_blank" style="text-decoration: none;">
              üîó View on Mermaid Live
            </a>
            <button class="btn btn-secondary" onclick="copyToClipboard('level1Code')">
              üìã Copy Code
            </button>
            <button class="btn btn-secondary" onclick="toggleCode('level1Code')">
              üëÅÔ∏è View Code
            </button>
          </div>

          <div class="mermaid-code" id="level1Code" style="display: none;">
            <pre id="level1CodeContent" style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto; margin: 10px 0;"></pre>
          </div>
        </div>

        <!-- Level 2 Results -->
        <div class="result-item">
          <h3>
            ‚öôÔ∏è Level 2: Detailed Operations
            <span class="badge">CRUD Operations</span>
          </h3>
          <p>Detailed CRUD operations for each data store</p>
          
          <div class="action-buttons">
            <a class="btn btn-primary" id="level2Live" target="_blank" style="text-decoration: none;">
              üîó View on Mermaid Live
            </a>
            <button class="btn btn-secondary" onclick="copyToClipboard('level2Code')">
              üìã Copy Code
            </button>
            <button class="btn btn-secondary" onclick="toggleCode('level2Code')">
              üëÅÔ∏è View Code
            </button>
          </div>
          <div class="mermaid-code" id="level2Code" style="display: none;">
            <pre id="level2CodeContent" style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto; margin: 10px 0;"></pre>
          </div>
        </div>

        <button class="btn btn-primary" onclick="resetForm()" style="width: 100%; margin-top: 20px;">
          üîÑ Generate Another DFD
        </button>
      </div>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInfo = document.getElementById('fileInfo');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const results = document.getElementById('results');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    let selectedFile = null;

    // Upload area click
    uploadArea.addEventListener('click', () => fileInput.click());

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    // Handle file selection
    function handleFileSelect(file) {
      if (!file.name.endsWith('.sql')) {
        showError('Please select a SQL file');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10 MB');
        return;
      }

      selectedFile = file;
      fileName.textContent = file.name;
      fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
      fileInfo.classList.add('active');
      uploadBtn.disabled = false;

      clearMessages();
    }

    // Upload and generate DFD
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      const formData = new FormData();
      formData.append('sqlFile', selectedFile);

      loading.classList.add('active');
      uploadBtn.disabled = true;
      clearMessages();

      try {
        const response = await fetch('/api/dfd/upload', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to generate DFD');
        }

        displayResults(data.data);
      } catch (error) {
        showError(error.message);
      } finally {
        loading.classList.remove('active');
      }
    });

    // Display results
    async function displayResults(data) {
      const { summary, details, mermaidCode, mermaidLiveLinks } = data;

      // Safe access with defaults
      const tables = summary.tables || [];
      const externalEntities = summary.externalEntities || [];
      const level1Processes = summary.level1Processes || [];
      const level2Processes = summary.level2Processes || [];

      // Display statistics with details
      let statsHtml = `
        <div class="stat-box">
          <div class="number">${summary.totalDataStores}</div>
          <div class="label">Data Stores</div>
        </div>
        <div class="stat-box">
          <div class="number">${summary.totalProcesses}</div>
          <div class="label">Total Processes</div>
        </div>
        <div class="stat-box">
          <div class="number">${summary.totalExternalEntities}</div>
          <div class="label">External Entities</div>
        </div>
        <div class="stat-box">
          <div class="number">${summary.totalLevels}</div>
          <div class="label">DFD Levels</div>
        </div>
      `;

      // Add detailed information section
      statsHtml += `
        <div style="grid-column: 1 / -1; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 15px;">
          <h4 style="color: #333; margin-bottom: 15px;">üìã System Analysis Details</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Data Stores -->
            <div>
              <h5 style="color: #667eea; margin-bottom: 10px;">üóÑÔ∏è Data Stores (${summary.totalDataStores})</h5>
              <ul style="list-style: none; padding: 0; font-size: 0.9em;">
                ${tables.length > 0 ? tables.map(t => `<li style="padding: 5px 0;">‚Ä¢ ${t}</li>`).join('') : '<li style="padding: 5px 0; color: #999;">No data stores</li>'}
              </ul>
            </div>

            <!-- External Entities -->
            <div>
              <h5 style="color: #667eea; margin-bottom: 10px;">üë• External Entities (${summary.totalExternalEntities})</h5>
              <ul style="list-style: none; padding: 0; font-size: 0.9em;">
                ${externalEntities.length > 0 ? externalEntities.map(e => `<li style="padding: 5px 0;">‚Ä¢ ${e}</li>`).join('') : '<li style="padding: 5px 0; color: #999;">No external entities</li>'}
              </ul>
            </div>

            <!-- Level 1 Processes -->
            <div>
              <h5 style="color: #667eea; margin-bottom: 10px;">1Ô∏è‚É£ Level 1 Processes</h5>
              <ul style="list-style: none; padding: 0; font-size: 0.9em;">
                ${level1Processes.length > 0 ? level1Processes.map(p => `<li style="padding: 5px 0;">‚Ä¢ ${p}</li>`).join('') : '<li style="padding: 5px 0; color: #999;">No processes</li>'}
              </ul>
            </div>

            <!-- Level 2 Processes -->
            <div>
              <h5 style="color: #667eea; margin-bottom: 10px;">2Ô∏è‚É£ Level 2 Processes (CRUD)</h5>
              <ul style="list-style: none; padding: 0; font-size: 0.9em; max-height: 150px; overflow-y: auto;">
                ${level2Processes.length > 0 ? level2Processes.slice(0, 8).map(p => `<li style="padding: 5px 0;">‚Ä¢ ${p}</li>`).join('') + (level2Processes.length > 8 ? `<li style="padding: 5px 0; color: #999;">+ ${level2Processes.length - 8} more...</li>` : '') : '<li style="padding: 5px 0; color: #999;">No processes</li>'}
              </ul>
            </div>
          </div>
        </div>
      `;

      document.getElementById('stats').innerHTML = statsHtml;

      // Level 0
      document.getElementById('level0CodeContent').textContent = mermaidCode.level0;
      document.getElementById('level0Live').href = mermaidLiveLinks.level0;

      // Level 1
      document.getElementById('level1CodeContent').textContent = mermaidCode.level1;
      document.getElementById('level1Live').href = mermaidLiveLinks.level1;

      // Level 2
      document.getElementById('level2CodeContent').textContent = mermaidCode.level2;
      document.getElementById('level2Live').href = mermaidLiveLinks.level2;

      // Display results section
      results.classList.add('active');
      showSuccess('‚úÖ DFD generated successfully! Click "View on Mermaid Live" to visualize diagrams.');
      window.scrollTo(0, document.querySelector('.results').offsetTop - 100);
    }

    function toggleCode(id) {
      const element = document.getElementById(id);
      if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
      }
    }

    function copyToClipboard(id) {
      const element = document.getElementById(id);
      const codeContent = element.querySelector('pre');
      if (codeContent) {
        const text = codeContent.textContent;
        navigator.clipboard.writeText(text).then(() => {
          alert('Mermaid code copied to clipboard! üìã');
        }).catch(err => {
          alert('Failed to copy: ' + err);
        });
      }
    }

    function resetForm() {
      selectedFile = null;
      fileInput.value = '';
      fileInfo.classList.remove('active');
      uploadBtn.disabled = true;
      results.classList.remove('active');
      clearMessages();
      window.scrollTo(0, 0);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('active');
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('active');
    }

    function clearMessages() {
      errorMessage.classList.remove('active');
      successMessage.classList.remove('active');
    }
  </script>
</body>
</html>